<!--
  Google Workspace rules ID: 64600 - 65499
-->
<var name="gworkspace_description">Google $(gworkspace.application) : $(gworkspace.eventname)</var>

<group name="gworkspace,">

  <rule id="64600" level="3">
    <decoded_as>json</decoded_as>
    <field name="gworkspace.application">\.+</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64601" level="14">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^wazuh extraction</field>
    <field name="gworkspace.eventname">^extraction error</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64602" level="12">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^wazuh extraction</field>
    <field name="gworkspace.eventname">^extraction warning</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64610" level="5">
    <if_sid>64600</if_sid>  
    <field name="gworkspace.application">^saml|^token|^login</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64612" level="6">
    <if_sid>64600</if_sid>  
    <field name="gworkspace.application">^admin|^groups|^context aware access|^access transparency|^gcp</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64614" level="7">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^rules|^user accounts</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64616" level="10">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^admin</field>
    <field name="gworkspace.eventtype">^security settings</field>
    <description>Google Workspace : Change of global $(gworkspace.eventtype) "$(gworkspace.eventname)"</description>
  </rule>

  <rule id="64618" level="9">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^admin</field>
    <field name="gworkspace.eventname">^reject from quarantine|^drop from quarantine</field>
    <description>$gworkspace_description</description>
  </rule>

  <rule id="64620" level="9">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^admin</field>
    <field name="gworkspace.eventname">^email log search</field>
    <description>$gworkspace_description</description>
  </rule>
  
  <rule id="64622" level="10">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^vault</field>
    <description>Google $(gworkspace.application) : mass data recovery, DLP warning for user $(user)</description>
    <group>DLP</group>
  </rule>

  <rule id="64624" level="12">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^admin</field>
    <field name="gworkspace.eventtype">^delegated admin</field>
    <description>Google $(gworkspace.application) : sensitive "$(gworkspace.eventname)" activity by user $(user)</description>
  </rule>

  <rule id="64626" level="12">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^access transparency</field>
    <description>Google Workspace : access to Workspace resources by Google</description>
  </rule>

  <rule id="64628" level="10">
    <if_sid>64600</if_sid>
    <field name="gworkspace.eventname">^login success$</field>
    <field name="gworkspace.parameters.login_type">^google_password$</field>
    <field name="gworkspace.parameters.is_suspicious">^true$</field>
    <description>Google Workspace : suspicious login by user $(user)</description>
  </rule>

  <rule id="64630" level="10">
    <if_sid>64600</if_sid>
    <field name="gworkspace.application">^mobile$</field>
    <field name="gworkspace.eventtype">^suspicious activity$</field>
    <description>Google Workspace : suspicious activity "$(gworkspace.eventname)" on device of user $(user)</description>
  </rule>

  <rule id="64632" level="10">
    <if_sid>64610</if_sid>
    <field name="gworkspace.application">^login$</field>
    <field name="gworkspace.eventtype">^account warning$|^attack warning$|^titanium change$|^email forwarding change$</field>
    <description>Google Workspace : warning of type "$(gworkspace.eventname)" for user $(user)</description>
  </rule>


  <rule id="64650" level="10" frequency="100" timeframe="300" ignore="600">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.application">^drive</field>
    <field name="gworkspace.eventname">^download</field>
    <same_field>user</same_field>
    <same_field>gworkspace.application</same_field>
    <same_field>gworkspace.eventname</same_field>
    <description>Google $(gworkspace.application) : intensive file download activity, DLP warning for user $(user)</description>
    <group>DLP</group>
  </rule>

  <rule id="64651" level="12" frequency="100" timeframe="300" ignore="600">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.application">^drive</field>
    <field name="gworkspace.eventname">^download</field>
    <field name="gworkspace.parameters.actor_is_collaborator_account">^true</field>
    <same_field>user</same_field>
    <same_field>gworkspace.application</same_field>
    <same_field>gworkspace.eventname</same_field>
    <description>Google $(gworkspace.application) : intensive file download activity, DLP warning for EXTERNAL user $(user)</description>
    <group>DLP</group>
  </rule>

<!--
  do not raise alerts for calendars, and exempt drive since it is managed by a specific rule (see below)
-->

  <rule id="64652" level="10" frequency="100" timeframe="60" ignore="600">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.application" negate="yes">^calendar|^drive</field>
    <field name="gworkspace.parameters.primary_event">^true</field>
    <same_field>user</same_field>
    <same_field>gworkspace.application</same_field>
    <same_field>gworkspace.eventname</same_field>
    <description>Google $(gworkspace.application) : intensive "$(gworkspace.eventname)" activity by user $(user)</description>
  </rule>

<!--
  special rule for drive events, where we only track intensive activity for primary events
-->
  <rule id="64653" level="10" frequency="100" timeframe="60" ignore="600">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.application">^drive</field>
    <field name="gworkspace.parameters.primary_event">^true</field>
    <same_field>user</same_field>
    <same_field>gworkspace.application</same_field>
    <same_field>gworkspace.eventname</same_field>
    <description>Google $(gworkspace.application) : intensive "$(gworkspace.eventname)" activity by user $(user)</description>
  </rule>

  <rule id="64654" level="12" frequency="30" timeframe="300" ignore="600">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.eventname">^login failure</field>
    <description>Google Workspace : Many failed logins, possible credential stuffing attack</description>
  </rule>

  <rule id="64700" level="10">
    <if_matched_sid>64600</if_matched_sid>
    <field name="gworkspace.application">^alert center</field>
    <description>$gworkspace_description</description>
  </rule>
  
  <rule id="64660" level="10">
  <if_sid>64600</if_sid>
  <field name="gworkspace.application">^admin$</field>
  <field name="gworkspace.eventname">^create user$</field>
  <description>Google Workspace : user created - $(gworkspace.parameters.USER_EMAIL)</description>
</rule>

<rule id="64661" level="10">
  <if_sid>64600</if_sid>
  <field name="gworkspace.application">^admin$</field>
  <field name="gworkspace.eventname">^delete user$</field>
  <description>Google Workspace : user deleted - $(gworkspace.parameters.USER_EMAIL)</description>
</rule>

<rule id="64662" level="8">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^suspend user$</field>
  <description>Google Workspace : user suspended - $(gworkspace.parameters.USER_EMAIL)</description>
</rule>

<rule id="64663" level="7">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^change password$</field>
  <description>Google Workspace : password changed - $(gworkspace.parameters.USER_EMAIL)</description>
</rule>


<rule id="64664" level="8">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^create group$</field>
  <description>Google Workspace : group created - $(gworkspace.parameters.GROUP_EMAIL)</description>
</rule>

<rule id="64665" level="8">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^delete group$</field>
  <description>Google Workspace : group deleted - $(gworkspace.parameters.GROUP_EMAIL)</description>
</rule>

<rule id="64666" level="7">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^add group member$</field>
  <description>Google Workspace : user $(gworkspace.parameters.USER_EMAIL) added to group $(gworkspace.parameters.GROUP_EMAIL)</description>
</rule>

  <rule id="64667" level="9">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^assign role$</field>
  <description>Google Workspace : role assigned - $(gworkspace.parameters.ROLE_NAME) to $(gworkspace.parameters.USER_EMAIL)</description>
</rule>

<rule id="64668" level="6">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^create role$</field>
  <description>Google Workspace : new delegated admin role created - $(gworkspace.parameters.ROLE_NAME)</description>
</rule>

<rule id="64669" level="12">
  <if_sid>64600</if_sid>
  <field name="gworkspace.eventname">^authorize api client access$</field>
  <description>Google Workspace : API client authorized - $(gworkspace.parameters.API_CLIENT_NAME)</description>
</rule>

</group>
  <!-- custom rule to change level from Graph API logs -->

<group name="ms-graph">
    <!--Add catchall rule -->
    <rule id="99500" level="3" overwrite="yes">
        <decoded_as>json-msgraph</decoded_as>
        <field name="integration">ms-graph</field>
        <options>no_full_log</options>
        <description>MS Graph message: Microsoft graph messages grouped.</description>
    </rule>
    
    </group>

<!-- Zeek + Modbus rules -->
<group name="zeek">
  <rule id="130001" level="5"> 
    <field name="dnsquery">\.+</field>
    <description>Zeek: DNS Query $(dnsquery) attempted from source ip $(src_ip) and source port $(src_port) resolved IP $(resolved_by) </description>
  </rule>
  <rule id="130002" level="3">
    <field name="src_port">5353</field>
    <description>Zeek: DNS Query $(dnsquery) attempted from source port 5353</description>
  </rule>
  <rule id="130003" level="7">
    <field name="connection_state">REJ</field>
    <description>Zeek: Connection from $(src_ip) to $(dst_ip) $(dst_port) rejected </description>
  </rule>
  <rule id="130004" level="3">
    <field name="src_port">5355</field>
    <description>Zeek: DNS Query $(dnsquery) attempted from destination port 5355</description>
  </rule>
  <rule id="130005" level="3">
    <field name="dnsquery">otx.alienvault.com</field>
    <description>Zeek: DNS Query $(dnsquery) exclude</description>
  </rule>
  <rule id="130006" level="3">
    <field name="dnsquery">cti.wazuh.com</field>
    <description>Zeek: DNS Query $(dnsquery) exclude</description>
  </rule>

  <rule id="139012" level="3">
    <field name="dst_port">22</field>
    <field name="connection_state">OTH</field>
    <description>Zeek: SSH connection  from $(src_ip) to $(dst_ip)</description>
  </rule>
  <rule id="130007" level="5">
    <field name="dst_port">22</field>
    <description>Zeek: SSH connection  from $(src_ip) to $(dst_ip) for $(duration_of_the_connection) seconds</description>
  </rule>
  <rule id="139008" frequency="3" timeframe="60" level="10">
    <if_matched_sid>130007</if_matched_sid>
    <field name="dst_port">22</field>
    <field name="software_name">inappropriate_FIN</field>
    <field name="src_ip">\.*</field>
    <description>Potential SSH brute-force attempt: Zeek 'data_before_established' on port 22</description>
  </rule>
  <rule id="139011" level="7">
    <field name="software_name">data_before_established</field>
    <field name="src_ip">\.*</field>
    <field name="dst_port">\.*</field>
    <description>Zeek: Suspecious Activity detected from source ip $(src_ip) to destination port $(dst_port)</description>
  </rule>
  <rule id="139009" frequency="5" timeframe="10" level="10">
    <if_matched_sid>139011</if_matched_sid>
    <field name="software_name">data_before_established</field>
    <description>Zeek anomaly: Multiple 'data_before_established' connections from same IP â€” possible TCP scan</description>
  </rule>

  <rule id="139010" level="12" timeframe="60" frequency="2">
    <if_matched_sid>139011</if_matched_sid>
    <field name="software_name">data_before_established</field>
    <field name="src_ip">\.*</field>
    <field name="dst_port">\.*</field>
    <description>TCP scanning detected: Source IP triggered both data_before_established and inappropriate_FIN anomalies</description>
  </rule>
  <rule id="139013" level="7">
    <field name="software_name">bad_HTTP_request</field>
    <description>Zeek anomaly: Suspecious HTTP request from source IP $(src_ip) to destination port $(dst_port)</description>
  </rule>
  <rule id="139014" frequency="3" timeframe="30" level="10">
    <if_matched_sid>139013</if_matched_sid>
    <description>Possible DoS attack: $(src_ip) triggered Zeek weird log 10 times in 30 seconds</description>
  </rule>

<rule id="139015" level="3">
    <field name="function">READ_INPUT_REGISTERS</field>
    <description>OT Modbus READ_INPUT_REGISTERS observed (normal polling)</description>
  </rule>
<rule id="139016" frequency="3" timeframe="60" level="10">
    <if_matched_sid>139015</if_matched_sid>
    <description>OT ALERT: Excessive Modbus READ_INPUT_REGISTERS requests detected from $(src_ip)</description>
  </rule>
<rule id="139017" level="12">
    <field name="function">WRITE_MULTIPLE_COILS</field>
    <description>OT CRITICAL: PLC process manipulation attempt detected from $(src_ip)</description>
  </rule>
<rule id="139018" level="9">
    <field name="exception">ILLEGAL_DATA_ADDRESS</field>
    <description>OT ALERT: Modbus request rejected by PLC (Illegal Data Address) from $(src_ip)</description>
  </rule>
<rule id="139019" level="12" frequency="2" timeframe="60">
    <if_matched_sid>139018</if_matched_sid>
    <description>OT ALERT: Repeated Modbus illegal address requests (probing behavior) from $(src_ip)</description>
  </rule>
</group>
<!--
<group name="attack,">
  <rule id="139020" level="10">
    <if_sid>139019</if_sid>
    <list field="src_ip" lookup="address_match_key">etc/lists/malicious-ioc/malicious-ip</list>
    <description>Probing IP found in blacklisted database.</description>
  </rule>

</group>
 -->

<!-- custom Suricata rules -->
<group name="custom_active_response_rules,">
  <rule id="300200" level="12">
    <if_sid>86600</if_sid>
    <field name="event_type">^alert$</field>
    <match>ET DOS Inbound GoldenEye DoS attack</match>
    <description>GoldenEye DoS attack has been detected. </description>
    <mitre>
      <id>T1498</id>
    </mitre>
  </rule>

  <rule id="300201" level="12">
    <if_sid>86600</if_sid>
    <field name="event_type">^alert$</field>
    <match>ET SCAN Nmap Scripting Engine User-Agent Detected (Nmap Scripting Engine)</match>
    <description>Nmap scripting engine detected. </description>
    <mitre>
      <id>T1595</id>
    </mitre>
  </rule>
  <rule id="300202" level="5">
    <if_sid>86602</if_sid>
    <field name="http.url">\.*</field>
    <match>modbus</match>
    <description>Modbus: Communication detected from source ip $(src_ip) and source port $(src_port) with status code $(http.status). </description>
  </rule>
  <rule id="300203" level="10">
    <if_sid>86600</if_sid>
    <field name="http.http_method">POST</field>
    <description>Modbus: Unauthorized modification attempt detected from source ip $(src_ip) and source port $(src_port) with status code $(http.status). </description>
  </rule>
</group>

<!-- RAPID SCADA rules -->

<!-- RAPID SCADA rules -->

<!-- =============================== -->
<!-- FIM / Syscheck rules -->
<!-- =============================== -->
<group name="syscheck,rapid_scada,">

  <rule id="110051" level="0">
    <if_sid>550</if_sid>
    <field name="file" type="pcre2">^.:\\Program Files\\SCADA\\.*</field>
    <description>Rapid SCADA: File modified.</description>
  </rule>

  <rule id="110052" level="7">
    <if_sid>110051</if_sid>
    <field name="changed_content" negate="yes" type="pcre2">^No content changes were found for this file\.$</field>
    <description>Rapid SCADA: File modified - $(file).</description>
    <mitre><id>T1565.001</id></mitre>
  </rule>

  <rule id="110053" level="7">
    <if_sid>553</if_sid>
    <field name="file" type="pcre2">^.:\\Program Files\\SCADA\\.*</field>
    <description>Rapid SCADA: File deleted - $(file).</description>
    <mitre>
      <id>T1070.004</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <rule id="110054" level="7">
    <if_sid>554</if_sid>
    <field name="file" type="pcre2">^.:\\Program Files\\SCADA\\.*</field>
    <description>Rapid SCADA: File added - $(file).</description>
  </rule>

  <rule id="110055" level="10">
    <if_sid>110052</if_sid>
    <field name="file" type="pcre2">config\.xml$</field>
    <description>Rapid SCADA: Configuration file modified - $(file).</description>
    <mitre><id>T1565.001</id></mitre>
  </rule>

  <rule id="110056" level="10">
    <if_sid>110053</if_sid>
    <field name="file" type="pcre2">config\.xml$</field>
    <description>Rapid SCADA: Configuration file deleted - $(file).</description>
    <mitre>
      <id>T1070.004</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <rule id="110057" level="10">
    <if_sid>110054</if_sid>
    <field name="file" type="pcre2">config\.xml$</field>
    <description>Rapid SCADA: Configuration file added - $(file).</description>
  </rule>

  <rule id="110058" level="10">
    <if_sid>110052</if_sid>
    <field name="file" type="pcre2">(user|role|roleref)\.dat$</field>
    <description>Rapid SCADA: User account manipulation - $(file) modified.</description>
    <mitre><id>T1098</id></mitre>
  </rule>

  <rule id="110059" level="10">
    <if_sid>110053</if_sid>
    <field name="file" type="pcre2">(user|role|roleref)\.dat$</field>
    <description>Rapid SCADA: User account manipulation - $(file) deleted.</description>
    <mitre><id>T1098</id></mitre>
  </rule>

  <rule id="110060" level="10">
    <if_sid>110054</if_sid>
    <field name="file" type="pcre2">(user|role|roleref)\.dat$</field>
    <description>Rapid SCADA: User account manipulation - $(file) created.</description>
    <mitre><id>T1098</id></mitre>
  </rule>

</group>

<!-- =============================== -->
<!-- Rapid SCADA log rules (NO location) -->
<!-- =============================== -->
<group name="rapid_scada,">
<!--
  <rule id="111061" level="3">
    <decoded_as>rapid-scada-no-ip</decoded_as>
    <description>Rapid SCADA: $(status) - $(message).</description>
  </rule>

  <rule id="111062" level="7">
    <if_sid>111061</if_sid>
    <status type="pcre2">^ERR$</status>
    <description>Rapid SCADA ERROR: $(message).</description>
  </rule>
-->
  <!-- Auth -->
  <rule id="111063" level="6">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">successfully authenticated</field>
    <description>Rapid SCADA: Successful authentication - $(message).</description>
    <mitre><id>T1078</id></mitre>
  </rule>

  <!-- Sessions -->
  <rule id="111064" level="5">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Session with ID .* created</field>
    <description>Rapid SCADA: Session created - $(message).</description>
  </rule>

  <!-- Client connection -->
  <rule id="111065" level="5">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Client .* connected</field>
    <description>Rapid SCADA: Client connected - $(message).</description>
  </rule>

  <rule id="111066" level="4">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Client .* disconnected</field>
    <description>Rapid SCADA: Client disconnected - $(message).</description>
  </rule>

  <!-- File transfer -->
  <rule id="111067" level="9">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Receive file \[Agent\]\\\[Temp\]\\upload_config_.*\.zip</field>
    <description>Rapid SCADA: Configuration package uploaded - $(message).</description>
    <mitre><id>T1105</id></mitre>
  </rule>

  <rule id="111068" level="4">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Temporary file upload_config_.*\.zip deleted</field>
    <description>Rapid SCADA: Temp configuration package deleted - $(message).</description>
  </rule>

  <!-- Runtime control -->
  <rule id="111069" level="6">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Agent .* started</field>
    <description>Rapid SCADA: Agent started - $(message).</description>
  </rule>

  <rule id="111070" level="10">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Agent is stopped</field>
    <description>Rapid SCADA: Agent stopped - $(message).</description>
    <mitre><id>T1489</id></mitre>
  </rule>

  <rule id="111071" level="7">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Start listener on port</field>
    <description>Rapid SCADA: Listener started - $(message).</description>
  </rule>

  <rule id="111072" level="8">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Stop listener|Listener is stopped</field>
    <description>Rapid SCADA: Listener stopped - $(message).</description>
  </rule>

  <rule id="111073" level="9">
    <if_sid>111061</if_sid>
    <field name="message" type="pcre2">Logic processing is stopped</field>
    <description>Rapid SCADA: Logic processing stopped - $(message).</description>
    <mitre><id>T1489</id></mitre>
  </rule>


</group>

  <!-- Modify it at your will. -->

<group name="couchdb">
<rule id="300100" level="8">
    <if_sid>30103</if_sid>
    <match>^[notice] </match>
    <field name="http_method">PUT</field>
    <description>CouchDB: document added by user $(dstuser) from $(srcip) on $(dstip) - Endpoint: $(endpoint)</description>
  </rule>
<rule id="300101" level="5">
    <if_sid>30103</if_sid>
    <match>^[notice] </match>
    <field name="http_method">GET</field>
    <description>CouchDB: document viewed by user $(dstuser) from $(srcip) on $(dstip) - Endpoint: $(endpoint)</description>
  </rule>
<rule id="300102" level="8">
    <if_sid>30103</if_sid>
    <match>^[notice] </match>
    <field name="http_method">DELETE</field>
    <description>CouchDB: document deleted by user $(dstuser) from $(srcip) on $(dstip) - Endpoint: $(endpoint)</description>
  </rule>
<rule id="300103" level="8">
    <if_sid>30103</if_sid>
    <match>^[notice] </match>
    <field name="http_method">POST</field>
    <description>CouchDB: document modified by user $(dstuser) from $(srcip) on $(dstip) - Endpoint: $(endpoint)</description>
  </rule>
<rule id="300104" level="10">
    <if_sid>2501</if_sid>
    <match>^[warning] </match>
    <description>CouchDB: Authentication failed user $(dstuser) from $(srcip)</description>
  </rule>
</group>

